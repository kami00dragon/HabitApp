<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitApp</title>
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --bg-color: #FAF9F6;
            --card-bg: #FFFFFF;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --shadow: 0 4px 15px rgba(0,0,0,0.06);
            --radius: 24px;
            --color-mental: #16A085; /* Verde */
            --color-physical: #D35400; /* Naranja */
            --color-neutral: #BDC3C7; 
            --accent-btn: #34495E;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }

        body { background-color: var(--bg-color); color: var(--text-main); padding-bottom: 100px; }

        header { padding: 30px 20px 20px 20px; text-align: center; }
        h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; color: var(--text-main); }

        main { padding: 10px 20px; max-width: 900px; margin: 0 auto; }

        /* TARJETAS */
        .habit-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            padding: 25px;
            position: relative;
        }
        
        .theme-mental { border-left: 6px solid var(--color-mental); }
        .theme-physical { border-left: 6px solid var(--color-physical); }

        .card-left { flex: 1; display: flex; flex-direction: column; margin-right: 20px; min-width: 0; }
        
        .card-header { margin-bottom: 15px; flex-shrink: 0; }
        
        .card-title { 
            font-size: 1.3rem; font-weight: 700; color: var(--text-main); 
            cursor: pointer; border-bottom: 1px dashed transparent; display: inline-block;
        }
        .card-title:hover { border-bottom-color: var(--text-sub); color: var(--color-mental); }

        .card-subtitle { font-size: 0.95rem; color: var(--text-sub); margin-top: 4px; }

        /* SCROLL DE VIDEOS */
        .media-scroll-container {
            display: flex; gap: 15px; overflow-x: auto;
            padding-bottom: 10px; padding-top: 5px; margin-top: auto;
            width: 100%; scrollbar-width: none; -ms-overflow-style: none;
        }
        .media-scroll-container::-webkit-scrollbar { display: none; }

        .video-frame {
            width: 240px; height: 135px; border-radius: 12px; flex-shrink: 0;
            border: 1px solid #eee; background-color: #000; display: block;
        }

        /* Bot贸n Editar Video */
        .edit-video-btn {
            background: none; border: none; color: var(--text-sub);
            font-size: 0.8rem; cursor: pointer; margin-top: 5px;
            text-decoration: underline; padding: 0; text-align: left;
        }
        .edit-video-btn:hover { color: var(--color-physical); }

        /* CRONMETRO */
        .card-right {
            flex-shrink: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            margin-left: 10px; min-width: 90px;
        }

        .timer-container { 
            position: relative; width: 80px; height: 80px; 
            cursor: pointer; margin-bottom: 5px; user-select: none;
        }
        .timer-container:active { transform: scale(0.95); }

        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-circle-bg { fill: none; stroke: #f0f0f0; stroke-width: 6; }
        .timer-circle-progress { 
            fill: none; stroke: var(--color-neutral); stroke-width: 6; stroke-linecap: round; 
            stroke-dasharray: 220; stroke-dashoffset: 0; 
            transition: stroke-dashoffset 1s linear, stroke 0.3s; 
        }

        .timer-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.9rem; font-weight: bold; color: var(--text-main); pointer-events: none;
        }

        .edit-hint { font-size: 0.65rem; color: #aaa; text-align: center; opacity: 0.6; }

        .theme-mental .timer-circle-progress.active { stroke: var(--color-mental); }
        .theme-physical .timer-circle-progress.active { stroke: var(--color-physical); }

        /* SECCIONES Y BOTONES DE AGREGAR */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin: 30px 0 10px 5px; border-bottom: 1px solid #eee; padding-bottom: 5px;
        }
        
        .section-label {
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #999;
            font-weight: 700;
        }

        .add-small-btn {
            background: none; border: 1px solid #ddd; border-radius: 15px;
            color: #666; font-size: 0.8rem; padding: 2px 10px; cursor: pointer;
            transition: all 0.2s;
        }
        .add-small-btn:hover { background: var(--text-main); color: #fff; border-color: var(--text-main); }

        /* Bot贸n Principal de Agregar */
        .main-add-btn {
            display: block; width: 100%; padding: 20px; margin-top: 30px;
            background-color: var(--accent-btn); color: white; border: none;
            border-radius: var(--radius); font-size: 1.1rem; font-weight: bold;
            cursor: pointer; box-shadow: var(--shadow); transition: transform 0.2s;
        }
        .main-add-btn:hover { transform: translateY(-3px); background-color: #2c3e50; }

        /* --- RESPONSIVO --- */
        @media (max-width: 600px) {
            .habit-card { flex-direction: column; align-items: flex-start; }
            .card-left { width: 100%; margin-right: 0; margin-bottom: 15px; }
            .card-right { 
                width: 100%; flex-direction: row; justify-content: space-between; align-items: center;
                border-top: 1px solid #f0f0f0; padding-top: 15px; margin-left: 0;
            }
            .timer-container { margin-bottom: 0; margin-right: 10px; }
            .video-frame { width: 100%; height: 180px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>HabitApp</h1>
    </header>

    <main id="app-container"></main>

    <script>
        // --- ESTADO INICIAL Y CONFIGURACIN ---
        // Intentamos cargar del LocalStorage, si no, usamos estos por defecto
        const defaultHabits = [
            { id: 0, title: "Leer Literatura", subtitle: "Tiempo de lectura silenciosa", time: 60, type: 'mental' },
            { id: 1, title: "Estudiar: estudios formales", subtitle: "Carrera, Universidad, Institutos", time: 360, type: 'mental' },
            { id: 2, title: "Limpiar y Ordenar", subtitle: "Espacio vital y mental", time: 15, type: 'physical' },
            { id: 3, title: "Buscar Trabajo", subtitle: "Postulaciones y mejoras de CV", time: 30, type: 'mental' },
            { id: 5, title: "Estudiar (Autodidacta)", subtitle: "Cursos, libros t茅cnicos, habilidades", time: 60, type: 'mental' },
            { id: 6, title: "Emprendimiento", subtitle: "Trabajo manual y creativo", time: 45, type: 'mental' },
            { id: 7, title: "Meditar", subtitle: "Conexi贸n y respiraci贸n", time: 15, type: 'mental', videos: ["qXnXunyvCh4"] },
            
            // Ejercicios (Rutinas gen茅ricas)
            { id: 8, title: "Rutina 1", subtitle: "Ejercicios de fuerza", time: 45, type: 'physical', videos: ["g4G9cupKFO0"] },
            { id: 9, title: "Rutina 2", subtitle: "Tono y condici贸n f铆sica", time: 45, type: 'physical', videos: ["0RMIFVSW_us"] },
            { id: 10, title: "Rutina 3", subtitle: "Core y resistencia", time: 45, type: 'physical', videos: ["ImUCOWszpNU"] },
            
            // Yoga (Rutinas gen茅ricas)
            { id: 11, title: "Rutina de yoga 1", subtitle: "Flujo suave", time: 45, type: 'physical', videos: ["eNo0Ru8FcXs"] },
            { id: 12, title: "Rutina de yoga 2", subtitle: "Posturas avanzadas", time: 45, type: 'physical', videos: ["chf-_OMxexA"] },
            { id: 13, title: "Rutina de yoga 3", subtitle: "Estiramientos completos", time: 45, type: 'physical', videos: ["v7AYKMP6rOE"] }
        ];

        let habits = JSON.parse(localStorage.getItem('habitAppData')) || defaultHabits;
        const timersState = {};
        const container = document.getElementById('app-container');

        // Funci贸n para guardar
        function saveHabits() {
            localStorage.setItem('habitAppData', JSON.stringify(habits));
        }

        // --- SONIDO GONG (MS LARGO) ---
        function playGong() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            
            // Oscilador Principal
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine';
            // Frecuencia baja y ca铆da lenta
            osc.frequency.setValueAtTime(100, ctx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(35, ctx.currentTime + 5.0);
            // Decay de 10 segundos
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(1.0, ctx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 10.0);
            osc.start(); osc.stop(ctx.currentTime + 10.5);

            // Arm贸nico
            const osc2 = ctx.createOscillator();
            const gain2 = ctx.createGain();
            osc2.connect(gain2); gain2.connect(ctx.destination);
            osc2.type = 'triangle'; 
            osc2.frequency.setValueAtTime(200, ctx.currentTime); 
            osc2.frequency.exponentialRampToValueAtTime(70, ctx.currentTime + 3.0);
            gain2.gain.setValueAtTime(0, ctx.currentTime);
            gain2.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.05);
            gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 5.0);
            osc2.start(); osc2.stop(ctx.currentTime + 5.5);
        }

        // --- FUNCIONES DE EDICIN Y AGREGADO ---

        function extractVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function editTitle(id) {
            const habit = habits.find(h => h.id === id);
            const newTitle = prompt("Editar t铆tulo de la secci贸n:", habit.title);
            if (newTitle && newTitle.trim() !== "") {
                habit.title = newTitle;
                saveHabits();
                renderApp();
            }
        }

        function editVideo(id) {
            const habit = habits.find(h => h.id === id);
            if (!habit.videos) habit.videos = [];
            
            const currentUrl = habit.videos.length > 0 ? `https://www.youtube.com/watch?v=${habit.videos[0]}` : "";
            const newUrl = prompt("Pega aqu铆 el enlace del nuevo video de YouTube:", currentUrl);
            
            if (newUrl) {
                const videoId = extractVideoID(newUrl);
                if (videoId) {
                    // Reemplazamos el primer video por el nuevo
                    habit.videos[0] = videoId; 
                    saveHabits();
                    renderApp();
                } else {
                    alert("Enlace de YouTube no v谩lido.");
                }
            }
        }

        function addNewHabit(predefinedType = null) {
            const name = prompt("Nombre de la nueva secci贸n:");
            if (!name) return;

            let time = prompt("Tiempo (minutos):", "30");
            if (!time || isNaN(time)) time = 30;

            let type = 'mental'; // Default
            
            if (predefinedType) {
                type = predefinedType;
            } else {
                const typeInput = prompt("Tipo (escribe '1' para Estudio/Mental o '2' para F铆sico):", "1");
                type = (typeInput === '2') ? 'physical' : 'mental';
            }

            const newHabit = {
                id: Date.now(), // ID 煤nico basado en tiempo
                title: name,
                subtitle: "Nueva actividad",
                time: parseInt(time),
                type: type,
                videos: type === 'physical' ? [] : undefined // Si es f铆sico, preparamos array de video vac铆o
            };

            habits.push(newHabit);
            saveHabits();
            renderApp();
            
            // Scroll al fondo
            setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
        }

        // --- RENDERIZADO ---
        function renderApp() {
            container.innerHTML = '';
            let exerciseLabelAdded = false;
            let yogaLabelAdded = false;

            habits.forEach(habit => {
                // Gestionar Encabezados de Secci贸n
                const isExercise = habit.title.toLowerCase().includes("rutina") && !habit.title.toLowerCase().includes("yoga");
                const isYoga = habit.title.toLowerCase().includes("yoga");

                if (isExercise && !exerciseLabelAdded) {
                    createSectionHeader("Rutinas de Ejercicio", () => addNewHabit('physical'));
                    exerciseLabelAdded = true;
                }
                if (isYoga && !yogaLabelAdded) {
                    createSectionHeader("Rutinas de Yoga", () => addNewHabit('physical'));
                    yogaLabelAdded = true;
                }

                // Crear Tarjeta
                const card = document.createElement('div');
                card.className = `habit-card theme-${habit.type}`;

                // --- IZQUIERDA ---
                const leftDiv = document.createElement('div');
                leftDiv.className = 'card-left';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'card-header';
                
                // T铆tulo Editable
                const titleEl = document.createElement('div');
                titleEl.className = 'card-title';
                titleEl.innerText = habit.title;
                titleEl.title = "Clic para editar t铆tulo";
                titleEl.onclick = () => editTitle(habit.id);

                headerDiv.appendChild(titleEl);
                
                // Subt铆tulo
                const subEl = document.createElement('div');
                subEl.className = 'card-subtitle';
                subEl.innerText = habit.subtitle;
                headerDiv.appendChild(subEl);

                leftDiv.appendChild(headerDiv);

                // Videos (si existen)
                if (habit.videos && habit.videos.length > 0) {
                    const scrollDiv = document.createElement('div');
                    scrollDiv.className = 'media-scroll-container';
                    
                    habit.videos.forEach(vidId => {
                        const iframe = document.createElement('iframe');
                        iframe.className = 'video-frame';
                        iframe.src = `https://www.youtube.com/embed/${vidId}?rel=0&playsinline=1`; 
                        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                        iframe.setAttribute('allowfullscreen', '');
                        scrollDiv.appendChild(iframe);
                    });
                    leftDiv.appendChild(scrollDiv);

                    // Bot贸n Editar Video
                    const editVideoBtn = document.createElement('button');
                    editVideoBtn.className = 'edit-video-btn';
                    editVideoBtn.innerText = " Cambiar video";
                    editVideoBtn.onclick = () => editVideo(habit.id);
                    leftDiv.appendChild(editVideoBtn);
                }

                // --- DERECHA (CRONMETRO) ---
                const rightDiv = document.createElement('div');
                rightDiv.className = 'card-right';

                const timerContainer = document.createElement('div');
                timerContainer.className = 'timer-container';
                timerContainer.innerHTML = `
                    <svg class="timer-svg" viewBox="0 0 80 80">
                        <circle class="timer-circle-bg" cx="40" cy="40" r="35"></circle>
                        <circle class="timer-circle-progress" id="circle-${habit.id}" cx="40" cy="40" r="35"></circle>
                    </svg>
                    <div class="timer-text" id="text-${habit.id}">${habit.time}:00</div>
                `;
                
                // Eventos Timer
                timerContainer.addEventListener('click', () => toggleTimer(habit.id, habit.time, habit.type));
                timerContainer.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    editTime(habit.id, habit.type);
                });

                const editHint = document.createElement('div');
                editHint.className = 'edit-hint';
                editHint.innerText = 'Doble clic para tiempo';

                rightDiv.appendChild(timerContainer);
                rightDiv.appendChild(editHint);

                card.appendChild(leftDiv);
                card.appendChild(rightDiv);
                container.appendChild(card);

                // Estado del Timer
                if (!timersState[habit.id]) {
                    timersState[habit.id] = {
                        totalSeconds: habit.time * 60,
                        remainingSeconds: habit.time * 60,
                        interval: null,
                        isRunning: false
                    };
                }
            });

            // Bot贸n Principal Agregar al final
            const mainBtn = document.createElement('button');
            mainBtn.className = 'main-add-btn';
            mainBtn.innerText = "+ Agregar Nueva Secci贸n";
            mainBtn.onclick = () => addNewHabit();
            container.appendChild(mainBtn);
        }

        function createSectionLabel(text) {
            const label = document.createElement('div');
            label.className = 'section-label';
            label.innerText = text;
            container.appendChild(label);
        }

        function createSectionHeader(title, onAdd) {
            const div = document.createElement('div');
            div.className = 'section-header';
            
            const label = document.createElement('span');
            label.className = 'section-label';
            label.innerText = title;
            
            const btn = document.createElement('button');
            btn.className = 'add-small-btn';
            btn.innerText = "+ Agregar";
            btn.onclick = onAdd;

            div.appendChild(label);
            div.appendChild(btn);
            container.appendChild(div);
        }

        // --- LGICA TIMER ---
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function updateVisuals(id, remaining, total, type) {
            const textEl = document.getElementById(`text-${id}`);
            const circleEl = document.getElementById(`circle-${id}`);
            const hintEl = textEl.parentElement.nextElementSibling;
            
            textEl.innerText = formatTime(remaining);
            const circumference = 220;
            const offset = circumference - (remaining / total) * circumference;
            circleEl.style.strokeDashoffset = offset;

            if (timersState[id].isRunning) {
                circleEl.classList.add('active');
                hintEl.innerText = "En curso...";
            } else {
                circleEl.classList.remove('active');
                hintEl.innerText = remaining === 0 ? "隆Completado!" : "Doble clic para tiempo";
            }
        }

        function toggleTimer(id, initialTime, type) {
            const state = timersState[id];

            if (state.isRunning) {
                clearInterval(state.interval);
                state.isRunning = false;
            } else {
                if (state.remainingSeconds <= 0) state.remainingSeconds = initialTime * 60;
                
                state.isRunning = true;
                state.interval = setInterval(() => {
                    state.remainingSeconds--;
                    updateVisuals(id, state.remainingSeconds, state.totalSeconds, type);

                    if (state.remainingSeconds <= 0) {
                        clearInterval(state.interval);
                        state.isRunning = false;
                        playGong();
                        updateVisuals(id, 0, state.totalSeconds, type);
                        
                        const card = document.getElementById(`text-${id}`).closest('.habit-card');
                        card.style.backgroundColor = '#e8f8f5';
                        setTimeout(() => card.style.backgroundColor = '#fff', 1000);
                    }
                }, 1000);
            }
            updateVisuals(id, state.remainingSeconds, state.totalSeconds, type);
        }

        function editTime(id, type) {
            const state = timersState[id];
            const currentMins = Math.floor(state.totalSeconds / 60);
            const newMinutes = prompt("Nuevo tiempo (minutos):", currentMins);
            
            if (newMinutes !== null && !isNaN(newMinutes) && newMinutes > 0) {
                const seconds = parseInt(newMinutes) * 60;
                state.totalSeconds = seconds;
                state.remainingSeconds = seconds;
                
                // Tambi茅n actualizamos el dato base para que persista el cambio en el array principal
                const habit = habits.find(h => h.id === id);
                if(habit) habit.time = parseInt(newMinutes);
                saveHabits();

                if (state.isRunning) {
                    clearInterval(state.interval);
                    state.isRunning = false;
                }
                updateVisuals(id, state.remainingSeconds, state.totalSeconds, type);
            }
        }

        // Iniciar
        renderApp();

    </script>
</body>
</html>
